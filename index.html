<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ëª¸ê³¼ ì°½ì‘ ê³µë¶€ Â· ë£¨í‹´ ì²´í¬</title>

  <link rel="manifest" href="manifest.json">

  <style>
    :root{
      --bg:#f7f7f8; --card:#ffffff; --line:#e6e6e8;
      --text:#111; --muted:#6b7280; --accent:#2563eb;
      --pad:16px; --r:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(255,255,255,.9); backdrop-filter: blur(8px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:920px; margin:0 auto; padding: 14px var(--pad);}
    h1{margin:0; font-size:20px;}
    .sub{margin-top:4px; color:var(--muted); font-size:13px;}
    main{max-width:920px; margin:0 auto; padding: var(--pad); display:grid; gap:12px;}
    .grid{display:grid; grid-template-columns: 1fr; gap:12px;}
    @media (min-width:860px){ .grid{grid-template-columns: 1.2fr .8fr;} }

    .card{
      background:var(--card); border:1px solid var(--line);
      border-radius:var(--r); padding:14px;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
    }
    .card h2{margin:0 0 10px 0; font-size:16px;}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    input, select, button{
      font: inherit;
    }
    input, select{
      padding:10px 10px; border:1px solid var(--line);
      border-radius:10px; background:#fff;
    }
    button{
      padding:10px 12px; border-radius:10px; border:1px solid var(--line);
      background:#fff; cursor:pointer;
    }
    button.primary{background:var(--accent); color:#fff; border-color:transparent;}
    button:disabled{opacity:.5; cursor:not-allowed;}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border:1px solid var(--line);
      border-radius:999px; color:var(--muted); font-size:12px;
    }
    .list{margin:0; padding:0; list-style:none; display:grid; gap:10px;}
    .item{
      display:grid; gap:10px;
      border:1px solid var(--line);
      border-radius:12px; padding:12px;
      background:#fff;
    }
    .itemTop{display:flex; justify-content:space-between; gap:10px; align-items:flex-start;}
    .name{font-weight:700; font-size:15px;}
    .meta{color:var(--muted); font-size:12px; margin-top:2px;}
    .btns{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    .kpi{display:grid; grid-template-columns:repeat(3,1fr); gap:10px;}
    .kpi .box{
      border:1px solid var(--line); border-radius:12px; padding:10px; background:#fff;
    }
    .kpi .big{font-size:18px; font-weight:800;}
    .kpi .lab{color:var(--muted); font-size:12px;}
    .warn{color:#b45309;}
    .ok{color:#16a34a;}
    footer{max-width:920px; margin:0 auto; padding:0 var(--pad) 30px; color:var(--muted); font-size:12px;}
    .small{font-size:12px; color:var(--muted);}
    .sep{height:1px; background:var(--line); margin:12px 0;}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <h1>ëª¸ê³¼ ì°½ì‘ ê³µë¶€ Â· ë£¨í‹´ ì²´í¬</h1>
    <div class="sub">í•˜ë£¨ ë£¨í‹´ì„ ê¸°ë¡í•˜ê³ , 30ì¼ / 6ê°œì›” ëˆ„ì ìœ¼ë¡œ ì„±ì·¨ê°ì„ í™•ì¸í•´ìš”.</div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <h2>ì˜¤ëŠ˜ ë£¨í‹´</h2>

      <div class="row" style="justify-content:space-between;">
        <div class="row">
          <span class="pill" id="todayLabel">ì˜¤ëŠ˜</span>
          <span class="pill">ë°ì´í„°ëŠ” ì´ ë¸Œë¼ìš°ì €ì— ì €ì¥(ë¡œì»¬)</span>
        </div>
        <div class="row">
          <button id="resetTodayBtn" title="ì˜¤ëŠ˜ ì¹´ìš´íŠ¸ë§Œ 0ìœ¼ë¡œ">ì˜¤ëŠ˜ë§Œ ì´ˆê¸°í™”</button>
          <button id="exportBtn">ë‚´ë³´ë‚´ê¸°</button>
          <button id="importBtn">ê°€ì ¸ì˜¤ê¸°</button>
        </div>
      </div>

      <div class="sep"></div>

      <ul class="list" id="habitList"></ul>

      <div class="sep"></div>

      <div class="row">
        <input id="newName" placeholder="ìƒˆ í•  ì¼/ìŠµê´€ ì´ë¦„" style="flex:1; min-width:220px;">
        <select id="newType">
          <option value="count">í•˜ë£¨ ì—¬ëŸ¬ ë²ˆ (+1 ëˆ„ì )</option>
          <option value="binary">í•˜ë£¨ 1íšŒ (ì™„ë£Œ/ë¯¸ì™„ë£Œ)</option>
        </select>
        <input id="newTarget" type="number" min="1" value="1" style="width:110px;" title="í•˜ë£¨ ëª©í‘œ íšŸìˆ˜(ëˆ„ì í˜•ì—ë§Œ ì‚¬ìš©)">
        <button class="primary" id="addBtn">ì¶”ê°€</button>
      </div>
      <div class="small">â€» â€œí•˜ë£¨ ëª©í‘œâ€ëŠ” ëˆ„ì í˜•(ë¬¼ë§ˆì‹œê¸°/ìŠ¤íŠ¸ë ˆì¹­ ë“±)ì—ë§Œ ì ìš©ë¼ìš”.</div>
    </section>

    <aside class="card">
      <h2>ìš”ì•½</h2>

      <div class="kpi">
        <div class="box">
          <div class="big" id="kpiDone">0</div>
          <div class="lab">ì˜¤ëŠ˜ ëª©í‘œ ë‹¬ì„±(ê°œ)</div>
        </div>
        <div class="box">
          <div class="big" id="kpiTotal">0</div>
          <div class="lab">ì „ì²´ ë£¨í‹´(ê°œ)</div>
        </div>
        <div class="box">
          <div class="big" id="kpiPct">0%</div>
          <div class="lab">ë‹¬ì„±ë¥ </div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="row" style="justify-content:space-between; align-items:flex-end;">
        <div>
          <div class="name">ê¸°ê°„ ì„ íƒ</div>
          <div class="meta">30ì¼ / 6ê°œì›” ëˆ„ì  ë³´ê¸°</div>
        </div>
        <select id="rangeSel">
          <option value="30">ìµœê·¼ 30ì¼</option>
          <option value="180">ìµœê·¼ 6ê°œì›”(180ì¼)</option>
        </select>
      </div>

      <div class="sep"></div>

      <div id="rangeStats"></div>

      <div class="sep"></div>

      <div class="small warn">
        ğŸ’¡ íŒ: â€œì™„ë£Œ/ë¯¸ì™„ë£Œâ€ ë£¨í‹´ì€ í•˜ë£¨ì— ì™„ë£Œí•˜ë©´ ê·¸ë‚  1íšŒë¡œ ê¸°ë¡ë¼ìš”.
      </div>
    </aside>
  </div>
</main>

<footer>
  ì´ ì•±ì€ ê°œì¸ ë£¨í‹´ ê¸°ë¡ìš©ì…ë‹ˆë‹¤. (GitHub Pages + ë¸Œë¼ìš°ì € ë¡œì»¬ ì €ì¥ì†Œ)
</footer>

<script>
  // ---- Service worker ë“±ë¡ (PWA)
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
  }

  // ---- ê¸°ë³¸ ë£¨í‹´(ì‚¬ìš©ì ìš”ì²­ ëª©ë¡)
  const DEFAULT_HABITS = [
    { id: "run4k", name: "ë‹¬ë¦¬ê¸° 4km (ì´í‹€ì— 1ë²ˆ)", type: "binary", dailyTarget: 1 },
    { id: "bm", name: "ë°°ë³€ 1íšŒ", type: "binary", dailyTarget: 1 },
    { id: "guitar", name: "ê¸°íƒ€ì—°ìŠµ 20ë¶„", type: "binary", dailyTarget: 1 },
    { id: "read", name: "ì±…ì½ê³  ìš”ì•½(ë…ì„œ)", type: "binary", dailyTarget: 1 },
    { id: "urbansketch", name: "ì–´ë°˜ìŠ¤ì¼€ì¹˜ (ì£¼ 1íšŒ)", type: "binary", dailyTarget: 1 },
    { id: "water", name: "ë¬¼ë§ˆì‹œê¸°", type: "count", dailyTarget: 6 },
    { id: "break50", name: "50ë¶„ë§ˆë‹¤ ê±·ê¸°/ìŠ¤íŠ¸ë ˆì¹­ + ë©€ë¦¬ë³´ê¸°", type: "count", dailyTarget: 6 },
    { id: "writing", name: "ê¸€ì“°ê¸° (2ì£¼ 1íšŒ)", type: "binary", dailyTarget: 1 },
  ];

  const LS_KEY = "routineApp.v1";

  const $ = (id) => document.getElementById(id);
  const todayISO = () => new Date().toISOString().slice(0,10);

  function loadState(){
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) {
      return {
        habits: DEFAULT_HABITS,
        log: {} // { "YYYY-MM-DD": { habitId: {count, done} } }
      };
    }
    try { return JSON.parse(raw); } catch(e){
      return { habits: DEFAULT_HABITS, log: {} };
    }
  }
  function saveState(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }

  function ensureToday(s){
    const d = todayISO();
    s.log[d] ||= {};
    for (const h of s.habits){
      s.log[d][h.id] ||= (h.type === "count" ? {count:0} : {done:false});
    }
  }

  function setTodayLabel(){
    const d = new Date();
    const txt = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")} (ì˜¤ëŠ˜)`;
    $("todayLabel").textContent = txt;
  }

  function calcTodayProgress(s){
    const d = todayISO();
    const day = s.log[d] || {};
    let done = 0;
    for (const h of s.habits){
      const entry = day[h.id];
      if (!entry) continue;
      if (h.type === "count"){
        if ((entry.count||0) >= (h.dailyTarget||1)) done++;
      } else {
        if (entry.done) done++;
      }
    }
    const total = s.habits.length;
    return {done, total, pct: total ? Math.round(done/total*100) : 0};
  }

  function render(s){
    ensureToday(s);
    setTodayLabel();

    const d = todayISO();
    const day = s.log[d];

    const ul = $("habitList");
    ul.innerHTML = "";

    for (const h of s.habits){
      const li = document.createElement("li");
      li.className = "item";

      const top = document.createElement("div");
      top.className = "itemTop";

      const left = document.createElement("div");
      const name = document.createElement("div");
      name.className = "name";
      name.textContent = h.name;

      const meta = document.createElement("div");
      meta.className = "meta";

      const entry = day[h.id];

      if (h.type === "count"){
        const cur = entry.count || 0;
        const tgt = h.dailyTarget || 1;
        meta.innerHTML = `ì˜¤ëŠ˜: <b>${cur}</b> / ${tgt}  ${cur>=tgt ? '<span class="ok">âœ“ ë‹¬ì„±</span>' : ''}`;
      } else {
        meta.innerHTML = `ì˜¤ëŠ˜: ${entry.done ? '<span class="ok"><b>ì™„ë£Œ</b> âœ“</span>' : '<span class="warn">ë¯¸ì™„ë£Œ</span>'}`;
      }

      left.appendChild(name);
      left.appendChild(meta);

      const right = document.createElement("div");
      right.className = "btns";

      if (h.type === "count"){
        const plus = document.createElement("button");
        plus.textContent = "+1";
        plus.onclick = () => { entry.count = (entry.count||0) + 1; saveState(s); render(s); };

        const minus = document.createElement("button");
        minus.textContent = "-1";
        minus.onclick = () => { entry.count = Math.max(0, (entry.count||0) - 1); saveState(s); render(s); };

        const zero = document.createElement("button");
        zero.textContent = "0";
        zero.onclick = () => { entry.count = 0; saveState(s); render(s); };

        right.appendChild(plus);
        right.appendChild(minus);
        right.appendChild(zero);
      } else {
        const toggle = document.createElement("button");
        toggle.className = "primary";
        toggle.textContent = entry.done ? "ì·¨ì†Œ" : "ì™„ë£Œ";
        toggle.onclick = () => { entry.done = !entry.done; saveState(s); render(s); };
        right.appendChild(toggle);
      }

      const del = document.createElement("button");
      del.textContent = "ì‚­ì œ";
      del.onclick = () => {
        if (!confirm(`"${h.name}" ì„(ë¥¼) ì‚­ì œí• ê¹Œìš”?`)) return;
        // habitsì—ì„œ ì œê±°
        s.habits = s.habits.filter(x => x.id !== h.id);
        // ë¡œê·¸ì—ì„œë„ ì œê±°
        for (const dayKey of Object.keys(s.log)){
          if (s.log[dayKey] && s.log[dayKey][h.id]) delete s.log[dayKey][h.id];
        }
        saveState(s); render(s);
      };
      right.appendChild(del);

      top.appendChild(left);
      top.appendChild(right);

      li.appendChild(top);
      ul.appendChild(li);
    }

    const t = calcTodayProgress(s);
    $("kpiDone").textContent = t.done;
    $("kpiTotal").textContent = t.total;
    $("kpiPct").textContent = `${t.pct}%`;

    renderRangeStats(s);
  }

  function renderRangeStats(s){
    const days = Number($("rangeSel").value);
    const end = new Date(todayISO());
    const start = new Date(end);
    start.setDate(start.getDate() - (days-1));

    // per habit: totalCount, successDays
    const stat = {};
    for (const h of s.habits){
      stat[h.id] = { name: h.name, type: h.type, total: 0, successDays: 0, days: 0 };
    }

    for (let i=0;i<days;i++){
      const cur = new Date(start);
      cur.setDate(start.getDate()+i);
      const key = cur.toISOString().slice(0,10);
      const day = s.log[key];
      if (!day) continue;

      for (const h of s.habits){
        const e = day[h.id];
        if (!e) continue;
        stat[h.id].days += 1;

        if (h.type === "count"){
          const c = e.count || 0;
          stat[h.id].total += c;
          if (c >= (h.dailyTarget||1)) stat[h.id].successDays += 1;
        } else {
          if (e.done) stat[h.id].successDays += 1;
        }
      }
    }

    // í™”ë©´
    const box = $("rangeStats");
    box.innerHTML = "";

    const head = document.createElement("div");
    head.className = "small";
    head.textContent = `ì„ íƒ ê¸°ê°„: ìµœê·¼ ${days}ì¼ (ê¸°ë¡ì´ ìˆëŠ” ë‚  ê¸°ì¤€ìœ¼ë¡œ ì§‘ê³„)`;
    box.appendChild(head);

    const ul = document.createElement("ul");
    ul.className = "list";
    ul.style.marginTop = "10px";

    for (const h of s.habits){
      const it = stat[h.id];
      const li = document.createElement("li");
      li.className = "item";

      const top = document.createElement("div");
      top.className = "itemTop";

      const left = document.createElement("div");
      const nm = document.createElement("div");
      nm.className = "name";
      nm.textContent = it.name;

      const meta = document.createElement("div");
      meta.className = "meta";

      if (it.type === "count"){
        meta.innerHTML = `ëˆ„ì  íšŸìˆ˜: <b>${it.total}</b> Â· ëª©í‘œë‹¬ì„± ì¼ìˆ˜: <b>${it.successDays}</b>ì¼`;
      } else {
        meta.innerHTML = `ì„±ê³µ(ì™„ë£Œ) ì¼ìˆ˜: <b>${it.successDays}</b>ì¼`;
      }

      left.appendChild(nm);
      left.appendChild(meta);

      top.appendChild(left);
      li.appendChild(top);
      ul.appendChild(li);
    }

    box.appendChild(ul);
  }

  function slugId(name){
    return "h_" + name.trim().toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_ê°€-í£]/g,"").slice(0,30) + "_" + Math.random().toString(16).slice(2,6);
  }

  // ---- ì´ë²¤íŠ¸
  const state = loadState();
  ensureToday(state);

  $("addBtn").onclick = () => {
    const name = $("newName").value.trim();
    if (!name) return alert("ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
    const type = $("newType").value;
    const dailyTarget = Math.max(1, Number($("newTarget").value||1));

    const h = { id: slugId(name), name, type, dailyTarget: type==="count" ? dailyTarget : 1 };
    state.habits.unshift(h);
    ensureToday(state);
    saveState(state);
    $("newName").value = "";
    render(state);
  };

  $("newType").onchange = () => {
    const isCount = $("newType").value === "count";
    $("newTarget").disabled = !isCount;
  };

  $("rangeSel").onchange = () => render(state);

  $("resetTodayBtn").onclick = () => {
    if (!confirm("ì˜¤ëŠ˜ ê¸°ë¡ë§Œ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
    const d = todayISO();
    state.log[d] ||= {};
    for (const h of state.habits){
      state.log[d][h.id] = (h.type === "count" ? {count:0} : {done:false});
    }
    saveState(state);
    render(state);
  };

  $("exportBtn").onclick = async () => {
    const data = JSON.stringify(state, null, 2);
    try{
      await navigator.clipboard.writeText(data);
      alert("ë‚´ë³´ë‚´ê¸° ì™„ë£Œ! (í´ë¦½ë³´ë“œì— ë³µì‚¬ë¨)\në©”ëª¨ì¥/ë…¸ì…˜ ë“±ì— ë¶™ì—¬ë„£ì–´ ë³´ê´€í•  ìˆ˜ ìˆì–´ìš”.");
    }catch(e){
      prompt("ì•„ë˜ ë‚´ìš©ì„ ë³µì‚¬í•´ì„œ ì €ì¥í•´ ë‘ì„¸ìš”:", data);
    }
  };

  $("importBtn").onclick = () => {
    const txt = prompt("ê°€ì ¸ì˜¤ê¸°: ì´ì „ì— ë‚´ë³´ë‚¸ JSON í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.");
    if (!txt) return;
    try{
      const obj = JSON.parse(txt);
      if (!obj.habits || !obj.log) throw new Error("í˜•ì‹ ì˜¤ë¥˜");
      localStorage.setItem(LS_KEY, JSON.stringify(obj));
      location.reload();
    }catch(e){
      alert("ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”.");
    }
  };

  render(state);
</script>
</body>
</html>
